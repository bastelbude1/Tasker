#!/bin/bash
# Simulated p7s command for testing
# Usage: p7s hostname command [args...]

HOSTNAME="$1"
COMMAND="$2"
shift 2
ARGS="$@"

# Handle special test commands
if [[ "$COMMAND" == "pbtest" ]]; then
    # Connection test command - responds based on hostname pattern
    case "$HOSTNAME" in
        # Success scenarios (must contain "OK" for validation to pass)
        "p7s-success-host"|"p7s-connection-ok"|"validation-pass-server"|"connectivity-test"|"remotehost1"|"remotehost2"|"remotehost3"|"localhost")
            echo "p7s connection test OK"
            exit 0
            ;;
        # Access denied scenarios
        "p7s-denied-host"|"badhost")
            echo "Access denied for $HOSTNAME" >&2
            exit 1
            ;;
        # Connection failure scenarios
        "p7s-fail-host"|"validation-fail-server")
            echo "Host not reachable: $HOSTNAME" >&2
            exit 1
            ;;
        # Empty response scenarios (should fail validation)
        "p7s-empty-response"|"noresponse")
            echo ""  # Empty stdout - should fail validation
            exit 0
            ;;
        # Wrong response scenarios (should fail validation - no "OK")
        "wrongresponse")
            echo "Some other response without OK keyword"
            exit 0
            ;;
        # Timeout scenarios
        "p7s-timeout-host"|"timeout")
            echo "Testing p7s connection to $HOSTNAME..." >&2
            sleep 15  # Simulate timeout
            echo "p7s connection test OK"  # Won't be reached
            exit 0
            ;;
        # DNS resolution test
        "dns-resolve-test")
            echo "p7s connection test OK"
            exit 0
            ;;
        # Unknown host scenarios
        *)
            echo "Host not reachable: $HOSTNAME - connection failed" >&2
            exit 1
            ;;
    esac
fi

# Handle regular commands
echo "p7s: Executing '$COMMAND $ARGS' on $HOSTNAME"
echo "p7s: Command completed on $HOSTNAME"
exit 0