# TEST_METADATA: {"description": "Resource exhaustion prevention test","test_type": "validation_only","expected_exit_code": 20,"expected_success": false,"skip_host_validation": true}
# RESOURCE EXHAUSTION PREVENTION TEST
# Tests that thread pool is properly capped to prevent resource exhaustion
# Attempts to create 200 parallel threads (should be capped)

# === START TASK ===
task=0
hostname=localhost
command=echo
arguments=Testing resource exhaustion prevention with 200 requested threads
success=exit_0
on_success=1

# === EXCESSIVE PARALLEL REQUEST (200 threads) ===
# This should be capped to min(200, CPU_cores*2, 32)

task=1
type=parallel
max_parallel=200
tasks=101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120
timeout=10
on_success=2
on_failure=999
condition=all_success

# === WORKER TASKS (simplified for testing) ===

task=101
hostname=localhost
command=echo
arguments=Task 101
success=exit_0

task=102
hostname=localhost
command=echo
arguments=Task 102
success=exit_0

task=103
hostname=localhost
command=echo
arguments=Task 103
success=exit_0

task=104
hostname=localhost
command=echo
arguments=Task 104
success=exit_0

task=105
hostname=localhost
command=echo
arguments=Task 105
success=exit_0

task=106
hostname=localhost
command=echo
arguments=Task 106
success=exit_0

task=107
hostname=localhost
command=echo
arguments=Task 107
success=exit_0

task=108
hostname=localhost
command=echo
arguments=Task 108
success=exit_0

task=109
hostname=localhost
command=echo
arguments=Task 109
success=exit_0

task=110
hostname=localhost
command=echo
arguments=Task 110
success=exit_0

task=111
hostname=localhost
command=echo
arguments=Task 111
success=exit_0

task=112
hostname=localhost
command=echo
arguments=Task 112
success=exit_0

task=113
hostname=localhost
command=echo
arguments=Task 113
success=exit_0

task=114
hostname=localhost
command=echo
arguments=Task 114
success=exit_0

task=115
hostname=localhost
command=echo
arguments=Task 115
success=exit_0

task=116
hostname=localhost
command=echo
arguments=Task 116
success=exit_0

task=117
hostname=localhost
command=echo
arguments=Task 117
success=exit_0

task=118
hostname=localhost
command=echo
arguments=Task 118
success=exit_0

task=119
hostname=localhost
command=echo
arguments=Task 119
success=exit_0

task=120
hostname=localhost
command=echo
arguments=Task 120
success=exit_0

# === VERIFICATION TASK ===
task=2
hostname=localhost
command=echo
arguments=SUCCESS: Resource exhaustion prevention working - tasks completed with capped thread pool
success=exit_0

# === FAILURE HANDLER ===
task=999
hostname=localhost
command=echo
arguments=FAILURE: Something went wrong during resource test
success=exit_0