# TEST_METADATA: {"description": "Auto-recovery: Conditional Block LIMITATION", "test_type": "negative", "expected_exit_code": 1, "expected_success": false, "requires_wrapper": "recovery_test_wrapper.sh", "wrapper_args": "--skip-host-validation", "skip_host_validation": true, "note": "KNOWN BUG: Recovery resumes in WRONG branch after conditional block"}
# Automated recovery test for Conditional Block
# **CRITICAL BUG DEMONSTRATED:** Recovery does NOT properly handle conditional blocks
# When conditional completes if_true_tasks, recovery resumes in WRONG branch (if_false_tasks)
# This test DOCUMENTS the limitation - do NOT use --auto-recovery with conditional blocks!

# File-defined arguments
--auto-recovery
--skip-host-validation

# Global variables
HOST_PREFIX=localhost
TEST_VALUE=success

# Task 0: Setup task to create condition
task=0
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=@TEST_VALUE@

# Task 1: Conditional Block - evaluates @0_stdout@
# Should take if_true branch (tasks 10,11) since @0_stdout@ will be "success"
task=1
type=conditional
condition=@0_stdout@=success
if_true_tasks=10,11
if_false_tasks=20,21

# TRUE BRANCH (should execute)
task=10
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=True_branch_task_10_executed

task=11
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=True_branch_task_11_executed

# FALSE BRANCH (should NOT execute)
task=20
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=ERROR_False_branch_should_not_execute
return=1

task=21
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=ERROR_False_branch_task_21_should_not_execute
return=1

# Task 2: After conditional - stateful task that fails first run
task=2
hostname=@HOST_PREFIX@
exec=local
command=recovery_helper.sh
arguments=test_auto_recovery_conditional_block

# Task 3: Final task after recovery
task=3
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=Recovery_completed_conditional_branch_preserved
