# TEST_METADATA: {"description": "Auto-recovery: Parallel routing with min_success", "test_type": "positive", "expected_exit_code": 0, "expected_success": true, "requires_wrapper": "recovery_test_wrapper.sh", "wrapper_args": "--skip-host-validation", "skip_host_validation": true, "note": "Validates parallel block routing is preserved across recovery"}
# Automated recovery test for parallel block routing
# Validates that parallel block routing (on_success/on_failure) is properly preserved during recovery
# Tests that after parallel block completes with min_success, recovery continues at correct route
# BUG FIX: Now uses intended_next_task to preserve routing decisions

# File-defined arguments
--auto-recovery
--skip-host-validation

# Global variables
HOST_PREFIX=localhost

# Task 0: Setup task
task=0
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=Starting_min_success_test

# Task 1: Parallel block with min_success=3 (need 3 of 5 to succeed)
task=1
type=parallel
tasks=10,11,12,13,14
max_parallel=5
success=min_success=3
on_success=2
on_failure=99

# Parallel subtasks (10-14) - all should succeed
task=10
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=Subtask_10_executed

task=11
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=Subtask_11_executed

task=12
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=Subtask_12_executed

task=13
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=Subtask_13_executed

task=14
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=Subtask_14_executed

# Task 2: Stateful task after parallel block - fails first run
task=2
hostname=@HOST_PREFIX@
exec=local
command=recovery_helper.sh
arguments=test_auto_recovery_multi_task_success_min

# Task 3: Final success marker
task=3
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=Recovery_completed_min_success_evaluation_preserved

# Task 99: Failure handler (should NOT execute - min_success met)
task=99
hostname=@HOST_PREFIX@
exec=local
command=echo
arguments=ERROR_Failure_handler_should_not_execute
return=1
