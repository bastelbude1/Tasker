# TEST_METADATA: {"description": "Temp files cleaned up after workflow completion", "test_type": "positive", "expected_exit_code": 0, "expected_success": true, "expected_execution_path": [0, 1], "expected_final_task": 1}

# TEST 5: Cleanup Verification After Workflow
# ============================================
# Verifies that temp files are properly cleaned up at workflow completion
# (not at individual task completion).
#
# Expected Behavior:
#   - Task 0 generates 5MB output → temp file created
#   - Task 1 accesses @0_stdout@ → temp file still exists
#   - Workflow completes → cleanup() called
#   - Temp file deleted after workflow end
#
# Verification Strategy:
#   - This test verifies workflow success
#   - Manual verification: Check /tmp for tasker_* files after test
#   - Should find NO orphaned temp files from this test
#
# Size Calculation:
#   - 500 lines × 10KB = 5MB
#   - Above 1MB threshold → temp file created
#   - Marker at end proves temp file preserved during execution

--skip-host-validation
--skip-security-validation

# Task 0: Generate 5MB output (creates temp file)
task=0
hostname=localhost
command=python3
arguments=-c "data='X'*10000; [print(data) for _ in range(499)]; print('CLEANUP_MARKER')"
exec=local

# Task 1: Access output to prove temp file preserved during workflow
task=1
hostname=localhost
command=python3
arguments=-c "import sys; data = '''@0_stdout@'''; sys.exit(0 if 'CLEANUP_MARKER' in data else 1)"
exec=local
success=exit_0
