# TEST_METADATA: {"description": "Large output (≥10MB) temp file preserved for cross-task access", "test_type": "positive", "expected_exit_code": 0, "expected_success": true, "expected_execution_path": [0, 1], "expected_final_task": 1}

# TEST 3: Large Output (≥10MB) Temp File Preservation
# ====================================================
# Verifies that large outputs (≥10MB) use temp files and remain accessible
# during workflow execution for cross-task variable substitution.
#
# Expected Behavior:
#   - Task 0 generates 15MB output with marker at the end
#   - Temp file created (≥1MB threshold)
#   - Temp file NOT deleted at task completion
#   - Task 1 reads full 15MB via temp file, finds marker
#   - Temp file deleted only at workflow end
#
# Size Calculation:
#   - 1500 lines × 10KB per line = 15MB total
#   - Well above 1MB threshold → temp file created
#   - Marker at end proves full temp file access

--skip-host-validation
--skip-security-validation

# Task 0: Generate 15MB output with marker at end
task=0
hostname=localhost
command=python3
arguments=-c "data='X'*10000; import sys; _ = [sys.stdout.write(data + '\\n') for i in range(1499)]; print('MARKER_END_15MB')"
exec=local
stdout_split=newline,1499

# Task 1: Verify marker extracted from end of 15MB output via stdout_split
# CRITICAL TEST: stdout_split must read the FULL temp file to extract line 1499
# If temp file was deleted at task 0 completion, split would fail or get truncated data
# The fact that we successfully extract 'MARKER_END_15MB' from line 1499 proves:
# 1. Temp file was created (output ≥1MB)
# 2. Temp file was NOT deleted at task 0 completion
# 3. Full 15MB content was accessible for splitting
# 4. Split result correctly stored with stdout_truncated=False
# 5. Variable substitution @0_stdout@ gets split result (not raw 15MB)
task=1
hostname=localhost
command=echo
arguments=Marker from end of 15MB: @0_stdout@
exec=local
success=stdout~MARKER_END_15MB
